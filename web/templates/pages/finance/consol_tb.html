{{ define "pages/finance/consol_tb.html" }}
{{ template "layouts/base.html" . }}
{{ end }}

{{ define "title" }}Consolidated Trial Balance{{ end }}

{{ define "content" }}
<header class="page-header">
    <div class="page-header__content">
        <h1>Consolidated Trial Balance</h1>
        <div class="text-sm text-secondary">
            Group {{ .Data.GroupName }} â€” Reporting Currency {{ .Data.ReportingCCY }}
        </div>
    </div>
    <div class="page-header__actions">
        <a href="/finance/consol/tb/export.csv?group={{ .Data.Filters.GroupID }}&period={{ .Data.Filters.Period }}{{ if .Data.Filters.Entities }}&entities={{ range $i, $id := .Data.Filters.Entities }}{{ if $i }},{{ end }}{{ $id }}{{ end }}{{ end }}"
            class="btn btn--secondary">
            Export CSV
        </a>
        <a href="/finance/consol/tb/pdf?group={{ .Data.Filters.GroupID }}&period={{ .Data.Filters.Period }}{{ if .Data.Filters.Entities }}&entities={{ range $i, $id := .Data.Filters.Entities }}{{ if $i }},{{ end }}{{ $id }}{{ end }}{{ end }}"
            class="btn btn--secondary">
            Export PDF
        </a>
    </div>
</header>

<section class="card mb-6">
    <form method="get" action="/finance/consol/tb" class="form-row align-end">
        <div class="form-group col">
            <label for="group" class="form-label">Group ID</label>
            <input type="number" id="group" name="group" class="form-input" value="{{ .Data.Filters.GroupID }}" min="1"
                required>
        </div>
        <div class="form-group col">
            <label for="period" class="form-label">Period (YYYY-MM)</label>
            <input type="text" id="period" name="period" class="form-input" value="{{ .Data.Filters.Period }}"
                placeholder="2024-01" required>
        </div>
        <div class="form-group col">
            <label for="entities" class="form-label">Entities (comma separated IDs)</label>
            <input type="text" id="entities" name="entities" class="form-input"
                value="{{ range $i, $id := .Data.Filters.Entities }}{{ if $i }},{{ end }}{{ $id }}{{ end }}"
                placeholder="all">
        </div>
        <div class="form-group col-auto">
            <button type="submit" class="btn btn--primary">Apply Filters</button>
        </div>
    </form>
    {{ with index .Data.Errors "group" }}<p class="text-error mt-2">{{ . }}</p>{{ end }}
    {{ with index .Data.Errors "period" }}<p class="text-error mt-2">{{ . }}</p>{{ end }}
    {{ with index .Data.Errors "entities" }}<p class="text-error mt-2">{{ . }}</p>{{ end }}
</section>

{{ with index .Data.Errors "general" }}
<div class="alert alert--error mb-6">{{ . }}</div>
{{ end }}

<section class="card mb-6">
    <header class="card__header">
        <h2 class="card__title">Totals</h2>
    </header>
    <div class="card__body">
        <dl class="grid grid-cols-3 gap-4">
            <div>
                <dt class="text-sm text-secondary">Local Amount</dt>
                <dd class="text-xl font-bold">{{ formatDecimal .Data.Totals.Local }}</dd>
            </div>
            <div>
                <dt class="text-sm text-secondary">Group Amount</dt>
                <dd class="text-xl font-bold">{{ formatDecimal .Data.Totals.Group }}</dd>
            </div>
            <div>
                <dt class="text-sm text-secondary">Status</dt>
                <dd class="text-xl font-bold {{ if .Data.Totals.Balanced }}text-success{{ else }}text-error{{ end }}">
                    {{ if .Data.Totals.Balanced }}Balanced{{ else }}Unbalanced{{ end }}
                </dd>
            </div>
        </dl>
    </div>
</section>

<section class="card mb-6">
    <header class="card__header">
        <h2 class="card__title">Details</h2>
    </header>
    <div class="table-wrap">
        <table class="table table--compact">
            <thead>
                <tr>
                    <th>Group Account</th>
                    <th>Name</th>
                    <th class="text-right">Local Amount</th>
                    <th class="text-right">Group Amount</th>
                </tr>
            </thead>
            <tbody>
                {{ if .Data.Lines }}
                {{ range .Data.Lines }}
                <tr>
                    <td>{{ .GroupAccount }}</td>
                    <td>{{ .Name }}</td>
                    <td class="text-right">{{ formatDecimal .Local }}</td>
                    <td class="text-right">{{ formatDecimal .Group }}</td>
                </tr>
                {{ end }}
                {{ else }}
                <tr>
                    <td colspan="4" class="text-center text-secondary py-4">No data available</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>

<section class="card">
    <header class="card__header">
        <h2 class="card__title">Entity Contribution</h2>
    </header>
    <div class="table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>Entity</th>
                    <th class="text-right">Group Amount</th>
                    <th class="text-right">Contribution %</th>
                </tr>
            </thead>
            <tbody>
                {{ if .Data.Contribution }}
                {{ range .Data.Contribution }}
                <tr>
                    <td>{{ .Entity }}</td>
                    <td class="text-right">{{ formatDecimal .GroupAmt }}</td>
                    <td class="text-right">{{ printf "%.2f" .Pct }}%</td>
                </tr>
                {{ end }}
                {{ else }}
                <tr>
                    <td colspan="3" class="text-center text-secondary py-4">No data available</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>
{{ end }}