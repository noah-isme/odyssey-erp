{{ define "pages/delivery/order_form.html" }}
{{ template "layouts/base.html" . }}
{{ end }}

{{ define "title" }}New Delivery Order{{ end }}

{{ define "content" }}
<div class="delivery-order-form-wrapper">
    <header>
        <h1>Create Delivery Order</h1>
        <p>Create a new delivery order from a sales order</p>
    </header>

    <!-- Flash Messages -->
    {{ if .Flash }}
    <article class="flash-message flash-{{ .Flash.Kind }}">
        {{ .Flash.Message }}
    </article>
    {{ end }}

    <!-- Validation Errors -->
    {{ if .Data.Errors }}
    <article class="error-summary">
        <h4>Please correct the following errors:</h4>
        <ul>
            {{ range $field, $error := .Data.Errors }}
            <li><strong>{{ $field }}:</strong> {{ $error }}</li>
            {{ end }}
        </ul>
    </article>
    {{ end }}

    <form method="post" action="/delivery-orders" id="deliveryOrderForm">
        <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">

        <!-- Header Information -->
        <section>
            <h2>Delivery Information</h2>
            <div</section> class="grid">
                <div>
                    <label for="sales_order_id">Sales Order ID <span class="required">*</span></label>
                    <input
                        type="number"
                        name="sales_order_id"
                        id="sales_order_id"
                        required
                        placeholder="Enter sales order ID"
                        value="{{ if .Data.SalesOrderID }}{{ .Data.SalesOrderID }}{{ else if .Data.FormData }}{{ index .Data.FormData "sales_order_id" }}{{ end }}"
                        onchange="loadSalesOrderLines()"
                    >
                    <small>Enter the sales order ID to create delivery from</small>
                </div>
                <div>
                    <label for="warehouse_id">Warehouse <span class="required">*</span></label>
                    <input
                        type="number"
                        name="warehouse_id"
                        id="warehouse_id"
                        required
                        placeholder="Enter warehouse ID"
                        value="{{ if .Data.FormData }}{{ index .Data.FormData "warehouse_id" }}{{ end }}"
                    >
                    <small>Warehouse to fulfill from</small>
                </div>
            </div>

            <div class="grid">
                <div>
                    <label for="delivery_date">Scheduled Delivery Date <span class="required">*</span></label>
                    <input
                        type="date"
                        name="delivery_date"
                        id="delivery_date"
                        required
                        value="{{ if .Data.FormData }}{{ index .Data.FormData "delivery_date" }}{{ end }}"
                    >
                </div>
                <div>
                    <label for="driver_name">Driver Name</label>
                    <input
                        type="text"
                        name="driver_name"
                        id="driver_name"
                        placeholder="Driver name"
                        value="{{ if .Data.FormData }}{{ index .Data.FormData "driver_name" }}{{ end }}"
                    >
                </div>
            </div>

            <div class="grid">
                <div>
                    <label for="vehicle_number">Vehicle Number</label>
                    <input
                        type="text"
                        name="vehicle_number"
                        id="vehicle_number"
                        placeholder="Vehicle registration"
                        value="{{ if .Data.FormData }}{{ index .Data.FormData "vehicle_number" }}{{ end }}"
                    >
                </div>
                <div>
                    <label for="tracking_number">Tracking Number</label>
                    <input
                        type="text"
                        name="tracking_number"
                        id="tracking_number"
                        placeholder="Shipment tracking number"
                        value="{{ if .Data.FormData }}{{ index .Data.FormData "tracking_number" }}{{ end }}"
                    >
                </div>
            </div>

            <div>
                <label for="notes">Notes</label>
                <textarea
                    name="notes"
                    id="notes"
                    rows="3"
                    placeholder="Additional notes for this delivery"
                >{{ if .Data.FormData }}{{ index .Data.FormData "notes" }}{{ end }}</textarea>
            </div>
        </section>

        <!-- Line Items -->
        <section>
            <h2>Items to Deliver <span class="required">*</span></h2>
            <p>Add items from the sales order to this delivery</p>

            <div id="lineItemsContainer">
                <!-- Line items will be added here dynamically -->
                <div class="line-item" data-line-index="0">
                    <div class="grid">
                        <div>
                            <label>SO Line ID <span class="required">*</span></label>
                            <input type="number" name="so_line_id[]" required placeholder="Sales order line ID">
                        </div>
                        <div>
                            <label>Product ID <span class="required">*</span></label>
                            <input type="number" name="product_id[]" required placeholder="Product ID">
                        </div>
                        <div>
                            <label>Quantity <span class="required">*</span></label>
                            <input type="number" name="quantity[]" step="0.01" min="0.01" required placeholder="Qty to deliver">
                        </div>
                        <div>
                            <label>Notes</label>
                            <input type="text" name="line_notes[]" placeholder="Line notes">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button type="button" class="danger small" onclick="removeLine(this)">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" onclick="addLineItem()" class="secondary">+ Add Line Item</button>
        </section>

        <!-- Form Actions -->
        <footer>
            <div role="group">
                <a href="/delivery-orders" role="button" class="secondary">Cancel</a>
                <button type="submit">Create Delivery Order</button>
            </div>
        </footer>
    </form>
</div>

<style>
.required {
    color: #dc3545;
}
.error-summary {
    background-color: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
}
.error-summary h4 {
    margin-top: 0;
}
.error-summary ul {
    margin-bottom: 0;
}
.line-item {
    background-color: #f8f9fa;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
}
.small {
    font-size: 0.85em;
    padding: 0.25rem 0.5rem;
}
button.danger {
    background-color: #dc3545;
}
.flash-message {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 0.25rem;
}
.flash-success {
    background-color: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
}
.flash-error {
    background-color: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
}
</style>

<script>
let lineIndex = 1;

function addLineItem() {
    const container = document.getElementById('lineItemsContainer');
    const newLine = document.createElement('div');
    newLine.className = 'line-item';
    newLine.setAttribute('data-line-index', lineIndex);
    newLine.innerHTML = `
        <div class="grid">
            <div>
                <label>SO Line ID <span class="required">*</span></label>
                <input type="number" name="so_line_id[]" required placeholder="Sales order line ID">
            </div>
            <div>
                <label>Product ID <span class="required">*</span></label>
                <input type="number" name="product_id[]" required placeholder="Product ID">
            </div>
            <div>
                <label>Quantity <span class="required">*</span></label>
                <input type="number" name="quantity[]" step="0.01" min="0.01" required placeholder="Qty to deliver">
            </div>
            <div>
                <label>Notes</label>
                <input type="text" name="line_notes[]" placeholder="Line notes">
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button type="button" class="danger small" onclick="removeLine(this)">Remove</button>
            </div>
        </div>
    `;
    container.appendChild(newLine);
    lineIndex++;
}

function removeLine(button) {
    const container = document.getElementById('lineItemsContainer');
    const lineItems = container.querySelectorAll('.line-item');

    // Keep at least one line item
    if (lineItems.length > 1) {
        button.closest('.line-item').remove();
    } else {
        alert('At least one line item is required');
    }
}

function loadSalesOrderLines() {
    const soId = document.getElementById('sales_order_id').value;
    if (!soId) return;

    // TODO: Implement AJAX call to fetch deliverable SO lines
    // For now, this is a placeholder for future enhancement
    console.log('Loading lines for SO:', soId);
}

// Form validation
document.getElementById('deliveryOrderForm').addEventListener('submit', function(e) {
    const lineItems = document.querySelectorAll('.line-item');
    if (lineItems.length === 0) {
        e.preventDefault();
        alert('Please add at least one line item');
        return false;
    }
});
</script>
{{ end }}
