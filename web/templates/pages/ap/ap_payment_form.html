{{ define "pages/ap/ap_payment_form.html" }}
{{template "layouts/base.html" .}}
{{ end }}

{{define "title"}}Record Payment{{end}}

{{define "content"}}
<main class="container">
    <header>
        <nav aria-label="breadcrumb">
            <ul>
                <li><a href="/finance/ap/invoices">AP</a></li>
                <li><a href="/finance/ap/payments">Payments</a></li>
                <li>Record Payment</li>
            </ul>
        </nav>
        <h1>Record AP Payment</h1>
    </header>

    {{if .Data.Errors.general}}
    <article class="error">
        <p>{{.Data.Errors.general}}</p>
    </article>
    {{end}}

    <form method="post" action="/finance/ap/payments">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

        <section>
            <h2>Allocations</h2>
            <p>Split payment across multiple invoices if needed.</p>

            <div id="allocation-rows">
                <div class="grid allocation-row">
                    <label>
                        Invoice *
                        <select name="ap_invoice_id" required>
                            <option value="">-- Select Invoice --</option>
                            {{range .Data.Invoices}}
                            <option value="{{.ID}}" {{if eq $.Data.SelectedInvoiceID .ID}}selected{{end}}>
                                {{.Number}} - Supplier #{{.SupplierID}} - {{printf "%.2f" .Total}}
                            </option>
                            {{end}}
                        </select>
                    </label>
                    <label>
                        Allocation Amount *
                        <input type="number" name="allocation_amount" step="0.01" required placeholder="0.00">
                    </label>
                    <label>
                        &nbsp;
                        <button type="button" class="secondary outline" onclick="removeAllocation(this)">Remove</button>
                    </label>
                </div>
            </div>
            <button type="button" class="secondary" onclick="addAllocation()">+ Add Allocation</button>
        </section>

        <div class="grid">
            <label>
                Payment Amount *
                <input type="number" name="amount" step="0.01" required placeholder="0.00">
            </label>
            <label>
                Payment Date *
                <input type="date" name="paid_at" required>
            </label>
        </div>

        <label>
            Payment Method
            <select name="method">
                <option value="TRANSFER" selected>Bank Transfer</option>
                <option value="CASH">Cash</option>
                <option value="CHECK">Check</option>
                <option value="CREDIT_CARD">Credit Card</option>
                <option value="OTHER">Other</option>
            </select>
        </label>

        <label>
            Note
            <textarea name="note" placeholder="Optional payment notes..."></textarea>
        </label>

        <footer>
            <button type="submit" class="primary">Record Payment</button>
            <a href="/finance/ap/payments" role="button" class="secondary outline">Cancel</a>
        </footer>
    </form>

    <script>
        function addAllocation() {
            const container = document.getElementById('allocation-rows');
            const firstRow = container.querySelector('.allocation-row');
            if (!firstRow) return;
            const clone = firstRow.cloneNode(true);
            clone.querySelectorAll('select, input').forEach((el) => {
                el.value = '';
            });
            container.appendChild(clone);
        }

        function removeAllocation(button) {
            const container = document.getElementById('allocation-rows');
            const rows = container.querySelectorAll('.allocation-row');
            if (rows.length <= 1) {
                return;
            }
            const row = button.closest('.allocation-row');
            if (row) {
                row.remove();
            }
        }
    </script>
</main>
{{end}}
