{{ define "pages/close/periods.html" }}
{{ template "layouts/base.html" . }}
{{ end }}

{{ define "title" }}Period Close{{ end }}

{{ define "head" }}
<link rel="stylesheet" href="/static/css/close.css">
{{ end }}

{{ define "content" }}
{{ $data := .Data }}
<section class="page-header">
    <div>
        <p class="eyebrow">Period Close</p>
        <h1>Accounting Periods</h1>
        <p class="muted">Pantau status periode dan mulai close run untuk setiap perusahaan.</p>
    </div>
    <form method="get" action="/accounting/periods" class="filters">
        <label>
            Company ID
            <input type="number" name="company_id" min="0" value="{{ $data.CompanyID }}">
        </label>
        <label>
            Tahun
            <input type="number" name="year" min="1900" placeholder="2024" value="{{ $data.YearFilter }}">
        </label>
        <button type="submit">Terapkan</button>
    </form>
    {{ if $data.YearError }}<small class="text-danger">{{ $data.YearError }}</small>{{ end }}
</section>

<section class="card">
    <header class="card-heading">
        <div>
            <h2>Daftar Periode</h2>
            <p class="muted">{{ if gt $data.CompanyID 0 }}Perusahaan #{{ $data.CompanyID }}{{ else }}Semua Perusahaan{{ end }}</p>
        </div>
    </header>
    <div class="responsive-table">
        <table class="period-table">
            <thead>
            <tr>
                <th>Periode</th>
                <th>Rentang</th>
                <th>Status</th>
                <th>Close Run</th>
                <th>Aksi</th>
            </tr>
            </thead>
            <tbody>
            {{ if eq (len $data.Periods) 0 }}
                <tr>
                    <td colspan="5">Belum ada periode untuk filter ini.</td>
                </tr>
            {{ end }}
            {{ range $row := $data.Periods }}
                <tr>
                    <td>
                        <strong>{{ $row.Period.Name }}</strong>
                        <div class="muted">Company {{ if gt $row.Period.CompanyID 0 }}#{{ $row.Period.CompanyID }}{{ else }}N/A{{ end }}</div>
                    </td>
                    <td>
                        <div>{{ $row.Period.StartDate.Format "02 Jan 2006" }}</div>
                        <div class="muted">sampai {{ $row.Period.EndDate.Format "02 Jan 2006" }}</div>
                    </td>
                    <td>
                        {{ template "partials/close/status_badge.html" $row.StatusBadge }}
                    </td>
                    <td>
                        {{ if $row.HasRun }}
                            <a class="secondary outline" href="{{ $row.RunURL }}">Lihat Close</a>
                        {{ else }}
                            <span class="muted">Belum ada run</span>
                        {{ end }}
                    </td>
                    <td>
                        {{ if $row.ShowStartRun }}
                            <form method="post" action="/accounting/periods/{{ $row.Period.ID }}/close-run" class="inline-form">
                                <input type="hidden" name="csrf_token" value="{{ $.CSRFToken }}">
                                <input type="hidden" name="company_id" value="{{ if gt $row.Period.CompanyID 0 }}{{ $row.Period.CompanyID }}{{ else }}{{ $data.CompanyID }}{{ end }}">
                                <button type="submit">Mulai Close</button>
                            </form>
                        {{ else }}
                            {{ if $row.HasRun }}
                                <small class="muted">Lanjutkan dari halaman run</small>
                            {{ else }}
                                <small class="muted">Tidak tersedia</small>
                            {{ end }}
                        {{ end }}
                    </td>
                </tr>
            {{ end }}
            </tbody>
        </table>
    </div>
</section>

<section class="card">
    <h2>Buat Periode Baru</h2>
    <p class="muted">Gunakan form ini saat periode ledger belum tersedia di sistem.</p>
    <form method="post" action="/accounting/periods" class="grid">
        <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
        <label>
            Company ID
            <input type="number" name="company_id" min="1" required value="{{ if gt $data.CompanyID 0 }}{{ $data.CompanyID }}{{ else }}1{{ end }}">
        </label>
        <label>
            Nama Periode
            <input type="text" name="name" placeholder="2025-01" required>
        </label>
        <label>
            Tanggal Mulai
            <input type="date" name="start_date" required>
        </label>
        <label>
            Tanggal Selesai
            <input type="date" name="end_date" required>
        </label>
        <button type="submit">Simpan</button>
    </form>
</section>
{{ end }}
