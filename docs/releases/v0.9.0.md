# Release v0.9.0 — Phase 9: Sales & AR Complete

**Release Date:** 2026-01-11

## Overview

Phase 9 delivers complete Sales & Accounts Receivable functionality, including quotations, sales orders, delivery orders, and enhanced AR invoicing with payment allocation.

## New Features

### Cycle 9.1: Quotation & Sales Order ✅
- Quotation CRUD with approval workflow (Draft → Submitted → Approved/Rejected)
- Sales Order creation from approved quotations
- Sales Order status management (Draft → Confirmed → Delivered → Closed)
- Customer management integration

### Cycle 9.2: Delivery Order ✅
- Delivery Order creation from Sales Orders
- Partial delivery support with line-level tracking
- Warehouse selection and stock validation
- Delivery confirmation workflow

### Cycle 9.3: AR Invoice & Payment Enhancement ✅
- **Invoice Lines** — Detailed line items linked to delivery orders
- **Post/Void Workflow** — Draft → Posted → Paid status transitions
- **Payment Allocations** — Partial payment support across invoices
- **Enhanced Aging Report** — Summary by aging buckets with totals
- **Auto-Status Update** — Invoice auto-marked as PAID when fully allocated

## Database Changes

### New Tables
- `ar_invoice_lines` — Invoice line items
- `ar_payment_allocations` — Payment-to-invoice allocations

### Schema Enhancements
- `ar_invoices`: Added `delivery_order_id`, `subtotal`, `tax_amount`, workflow columns (`posted_at`, `posted_by`, `voided_at`, `voided_by`, `void_reason`)
- `ar_payments`: Added `created_by`

### New Functions
- `generate_ar_invoice_number()` — Auto-generate invoice numbers
- `generate_ar_payment_number()` — Auto-generate payment numbers
- `trg_update_invoice_status` — Auto-update invoice status on payment

### New Permissions
| Permission | Description |
|------------|-------------|
| `finance.ar.create` | Create AR invoices |
| `finance.ar.post` | Post AR invoices |
| `finance.ar.void` | Void AR invoices |
| `finance.ar.payment` | Record AR payments |

## API Endpoints

### AR Module
| Method | Path | Description |
|--------|------|-------------|
| GET | `/finance/ar/invoices` | List AR invoices |
| GET | `/finance/ar/invoices/new` | Create invoice form |
| POST | `/finance/ar/invoices` | Create invoice |
| GET | `/finance/ar/invoices/{id}` | Invoice detail |
| POST | `/finance/ar/invoices/{id}/post` | Post invoice |
| POST | `/finance/ar/invoices/{id}/void` | Void invoice |
| POST | `/finance/ar/invoices/from-delivery/{doID}` | Create from delivery |
| GET | `/finance/ar/payments` | List payments |
| GET | `/finance/ar/payments/new` | Payment form |
| POST | `/finance/ar/payments` | Record payment |
| GET | `/finance/ar/aging` | Aging report |

## Migration

```bash
# Run migration
migrate -path migrations -database "$PG_DSN" up

# Verify
psql $PG_DSN -c "SELECT * FROM schema_migrations ORDER BY version DESC LIMIT 3;"
```

## Breaking Changes

None.

## Known Issues

- New AR templates (`invoices_list.html`, `invoice_detail.html`) not embedded in binary. Using fallback templates.

## Upgrade Checklist

- [ ] Backup database
- [ ] Run migration `000022_phase9_3_ar_enhancement`
- [ ] Verify AR permissions assigned to roles
- [ ] Test AR invoice workflow
- [ ] Test payment allocation
